name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  GO_VERSION: '1.21'

jobs:
  # ============================================
  # Backend Build & Test
  # ============================================
  backend:
    name: Backend (Java ${{ matrix.java }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [21]

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: audittrail_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      elasticsearch:
        image: elasticsearch:8.11.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build
        run: mvn clean compile -DskipTests -B

      - name: Unit Tests
        run: mvn test -B -Dtest="!*IntegrationTest"

      - name: Integration Tests
        run: mvn test -B -Dtest="*IntegrationTest"
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/audittrail_test
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test
          SPRING_ELASTICSEARCH_URIS: http://localhost:9200

      - name: Package
        run: mvn package -DskipTests -B

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: '**/target/site/jacoco/jacoco.xml'
          flags: backend
          fail_ci_if_error: false

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: audit-trail-app/target/*.jar
          retention-days: 7

  # ============================================
  # SDK Java
  # ============================================
  sdk-java:
    name: SDK Java
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build & Test
        run: |
          cd audit-trail-sdk-java
          mvn clean verify -B

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: 'audit-trail-sdk-java/target/site/jacoco/jacoco.xml'
          flags: sdk-java

  # ============================================
  # SDK JavaScript/TypeScript
  # ============================================
  sdk-js:
    name: SDK JavaScript
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: audit-trail-sdk-js/package-lock.json

      - name: Install Dependencies
        run: |
          cd audit-trail-sdk-js
          npm ci

      - name: Lint
        run: |
          cd audit-trail-sdk-js
          npm run lint || true

      - name: Build
        run: |
          cd audit-trail-sdk-js
          npm run build

      - name: Test
        run: |
          cd audit-trail-sdk-js
          npm test

  # ============================================
  # SDK Python
  # ============================================
  sdk-python:
    name: SDK Python
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: audit-trail-sdk-python/pyproject.toml

      - name: Install Dependencies
        run: |
          cd audit-trail-sdk-python
          pip install -e ".[dev]"

      - name: Lint
        run: |
          cd audit-trail-sdk-python
          ruff check src/ || true

      - name: Type Check
        run: |
          cd audit-trail-sdk-python
          mypy src/ || true

      - name: Test
        run: |
          cd audit-trail-sdk-python
          pytest --cov=audit_trail_sdk --cov-report=xml

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: 'audit-trail-sdk-python/coverage.xml'
          flags: sdk-python

  # ============================================
  # SDK Go
  # ============================================
  sdk-go:
    name: SDK Go
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: audit-trail-sdk-go/go.sum

      - name: Build
        run: |
          cd audit-trail-sdk-go
          go build ./...

      - name: Test
        run: |
          cd audit-trail-sdk-go
          go test -v -race -coverprofile=coverage.out ./...

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: 'audit-trail-sdk-go/coverage.out'
          flags: sdk-go

  # ============================================
  # Docker Build (validation only)
  # ============================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: audit-trail-app/target/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: false
          tags: mohmk10/audit-trail-server:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Summary
  # ============================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend, sdk-java, sdk-js, sdk-python, sdk-go, docker]
    if: always()

    steps:
      - name: Check Results
        run: |
          if [[ "${{ needs.backend.result }}" == "failure" ]] || \
             [[ "${{ needs.sdk-java.result }}" == "failure" ]] || \
             [[ "${{ needs.sdk-js.result }}" == "failure" ]] || \
             [[ "${{ needs.sdk-python.result }}" == "failure" ]] || \
             [[ "${{ needs.sdk-go.result }}" == "failure" ]] || \
             [[ "${{ needs.docker.result }}" == "failure" ]]; then
            echo "::error::Some jobs failed"
            exit 1
          fi
          echo "All jobs passed!"
